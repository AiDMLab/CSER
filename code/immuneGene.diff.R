library("limma")
inputFile="TCGAexp.txt" #?????募?
fdrFilter=0.05 #fdr?俳?值
logFCfilter=1 #logFC?俳?值
conNum=44 #normal????品??目
treatNum=571 #tumor????品??目

#??取?????募?
outTab=data.frame()

#grade??781????签,前308????1??示??????品,??473????2??示??????品
grade=c(rep(1,conNum),rep(2,treatNum))

#??取?????募?
rt=read.table(inputFile,sep="\t",header=T,check.names=F)

#????一?????????侄??薪???取??值????
rt=as.matrix(rt)
rownames(rt)=rt[,1] #rt?牡?一????rt??????,也???腔?????????
exp=rt[,2:ncol(rt)] #exp?腔??????????械谋???量
dimnames=list(rownames(exp),colnames(exp)) #dimnames?腔????????趾???????????
data=matrix(as.numeric(as.matrix(exp)),nrow=nrow(exp),dimnames=dimnames) #data?腔??????????械谋???量
data=avereps(data) #????某?????????侄???,??取??值
#????一?????????侄??薪???取??值????

#????????????品?械谋???量?木?值小??0.2,??????????????品???谋???量???艿?,??删??????量?偷幕???
data=data[rowMeans(data)>0.2,]

#????????
#??每?械幕???????????????
for(i in row.names(data)){
  geneName=unlist(strsplit(i,"\\|",))[1] #?玫???????????
  geneName=gsub("\\/", "_", geneName)
  rt=rbind(expression=data[i,],grade=grade)
  rt=as.matrix(t(rt))
  wilcoxTest<-wilcox.test(expression ~ grade, data=rt) #????wilcox??????????????,????量????????品????????品???谋冉?.?冉虾????玫?p值
  conGeneMeans=mean(data[i,1:conNum])  #??????品?????????木?值
  treatGeneMeans=mean(data[i,(conNum+1):ncol(data)])  #??????品?????????木?值

  pvalue=wilcoxTest$p.v  
  logFC=log2(treatGeneMeans)-log2(conGeneMeans) alu
  e    #????wilcox??????p值1:c
  onNum])   #??????????品?谢???????????位值
  treatMed=median(data[i,(conNum+1):ncol(data)])  #??????????品?谢???????????位值
  diffMed=treatMed-conMed
  outTab=rbind(outTab,cbind(gene=i,conMean=conGeneMeans,treatMean=treatGeneMeans,logFC=logFC,pValue=pvalue))
	 
}
#循?????玫???outTab??13382???????牟???????,??括????????/????????值/????????值/logFC/p值

pValue=outTab[,"pValue"] #??????每????????p值
fdr=p.adjust(as.numeric(as.vector(pValue)),method="fdr") #??fdr?姆?????p值????校??
#outTab??8705???????牟???????,??括????????/????????值/????????值/logFC/p值/fdr值
outTab=cbind(outTab,fdr=fdr)

#???????谢????牟???????
write.table(outTab,file="all.txt",sep="\t",row.names=F,quote=F)

#????????????
#logFC?木???值???outTab$fdr))<fd( abs(as.numeric(as.vector(outTab$logFC)))>logFCfilter & as.numeric(as.vector(outTab$fdr)fle="diff.xls",sep="\t",row.names=F,quote=F)

#??????图??要???募?
#heatmap??8343??f[order(as.numeric(as.vector(outDiff$logFC))),]#8343???????牟???????,????logFC???fdr))),]#8343???????牟???????,????logFC????????????
diffGeneName=as.vector(diffSig$gene)#8343????????????????
diffLength=length(diffGeneName)#3676
hmGene=head(diffGeneName,10)
???械谋???量

#hmExp=data[as.vector(outDiff[,1]),] #??取?????write.table(hmExp,file="new10.txt",sep="\t",col.names=T,quote=F)?